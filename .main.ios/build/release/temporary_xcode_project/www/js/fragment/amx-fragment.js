(function(){var a=adf.mf.api.amx.TypeHandler.register(adf.mf.api.amx.AmxTag.NAMESPACE_AMX,"fragment");a.prototype.createChildrenNodes=function(a){null==a.getAttribute("src")?a.setState(null==a.getAttributeExpression("src")?adf.mf.api.amx.AmxNodeStates.UNRENDERED:adf.mf.api.amx.AmxNodeStates.INITIAL):(a.setAttributeResolvedValue("_fragmentState",{rendered:!1,placeholderRendered:!1,childrenCreated:!1,fragmentLoading:!1,waitingOnEl:a.getState()==adf.mf.api.amx.AmxNodeStates.WAITING_ON_EL_EVALUATION}),
this._createChildrenFromFragment(a));return!0};a.prototype.updateChildren=function(b,c){var d=b.getAttribute("_fragmentState");if(c.hasChanged("src")&&d.childrenCreated)return adf.mf.api.amx.AmxNodeChangeResult.REPLACE;if(c.hasChanged("_fragmentLoaded")&&(delete d.updateArguments,d.childrenCreated&&!d.placeholderRendered))return adf.mf.log.AMX.isLoggable(adf.mf.log.level.FINEST)&&adf.mf.log.AMX.logp(adf.mf.log.level.FINEST,"amx:fragment","updateChildren","Update children called due to attribute _fragmentLoaded, but the fragment has already been rendered. Node: "+
b.getId()),adf.mf.api.amx.AmxNodeChangeResult.NONE;c.hasChanged("_facetsToBeCreated")&&this._createFacets(b,b.isRendered());if(b.getState()==adf.mf.api.amx.AmxNodeStates.WAITING_ON_EL_EVALUATION){d.waitingOnEl=!0;if(d.placeholderRendered&&null!=document.getElementById(b.getId()))return b.setState(adf.mf.api.amx.AmxNodeStates.PARTIALLY_RENDERED),adf.mf.api.amx.AmxNodeChangeResult.NONE;b.setState(adf.mf.api.amx.AmxNodeStates.ABLE_TO_RENDER);return adf.mf.api.amx.AmxNodeChangeResult.REFRESH}var e=d.waitingOnEl=
!1,d=b.getAttribute("_fragmentState");d.childrenCreated||d.waitingOnEl||d.fragmentLoading||this._createChildrenFromFragment(b)&&(e=!0);d=a.superclass.updateChildren.call(this,b,c);return Math.max(adf.mf.api.amx.AmxNodeChangeResult[e?"REFRESH":"NONE"],d)};a.prototype.render=function(a){var c=a.getAttribute("_fragmentState"),d=document.createElement("div");c.waitingOnEl||0==c.childrenCreated?(d.className="amx-deferred-loading",a.setState(adf.mf.api.amx.AmxNodeStates.PARTIALLY_RENDERED),c.placeholderRendered=
!0):this._renderChildren(a,d);return d};a.prototype.refresh=function(b,c,d){var e=b.getAttribute("_fragmentState");if(!e.waitingOnEl&&0!=e.childrenCreated){var g=document.getElementById(b.getId());e.childrenCreated&&(e.placeholderRendered&&(e.placeholderRendered=!1,g.classList.remove("amx-deferred-loading")),e.rendered||this._renderChildren(b,g));a.superclass.refresh.call(this,b,c,d)}};a.prototype.visitChildren=function(a,c,d){var e=this._getFragmentUri(a),g=!1;null==this._fragmentStack?(this._fragmentStack=
[e],g=!0):this._fragmentStack.push(e);try{if(a.visitStampedChildren(null,null,null,c,d))return!0}finally{g?delete this._fragmentStack:this._fragmentStack.pop()}e=a.getAttribute("_facetVisitData");if(null!=e)for(var g=0,h=e.length;g<h;++g){var k=e[g],m=k.name,n=k.attributes,k=k.key;this._setupFacetContext(n);try{if(a.visitStampedChildren(k,[m],null,c,d))return!0}finally{this._tearDownFacetContext(n)}}return!1};a.prototype.__removeFacet=function(a,c){var d=c.getAttribute("facetName"),e=a.getAttribute("_facetVisitData"),
g=c.getId(),d=a.getChildren(d,g);if(0<d.length)for(var h=d.length-1;0<=h;--h){if(a.removeChild(d[h])||this._removePendingFacetRefCreation(a,c),null!=e)for(var k=0,m=e.length;k<m;++k)if(e[k].key==g){e.splice(k,1);break}}else this._removePendingFacetRefCreation(a,c)};a.prototype._renderChildren=function(a,c){for(var d=a.renderDescendants(),e=0,g=d.length;e<g;++e)c.appendChild(d[e]);d=a.getAttribute("_fragmentState");d.placeholderRendered=!1;d.rendered=!0;a.setState(adf.mf.api.amx.AmxNodeStates.RENDERED)};
a.prototype._removePendingFacetRefCreation=function(a,c){var d=a.getAttribute("_facetsToBeCreated");if(null!=d)for(var e=0,g=d.length;e<g;++e)c===d[e]&&(d.splice(e,1),--g,--e)};a.prototype._setupFacetContext=function(a){if(null!=a)for(var c=0,d=a.length;c<d;++c){var e=a[c];adf.mf.api.pushVariable(e.name,e.value)}};a.prototype._tearDownFacetContext=function(a){if(null!=a)for(var c=0,d=a.length;c<d;++c)adf.mf.api.popVariable(a[c].name)};a.prototype._getFragmentUri=function(a){var c=a.getAttribute("_uri");
if(null==c&&(c=a.getAttribute("src"),null!=c))if(null==this._fragmentStack||"/"==c[0])c=adf.mf.api.amx.buildRelativePath(c);else{var d=this._fragmentStack[this._fragmentStack.length-1],e=d.lastIndexOf("/");0<=e&&(c=d.substring(0,e)+"/"+c)}a.setAttributeResolvedValue("_uri",c);return c};a.prototype._isInfiniteLoop=function(a,c){var d=this._fragmentStack;if(d)if(adf.mf.environment.profile.dtMode){if(0<=d.indexOf(c))return a.setState(adf.mf.api.amx.AmxNodeStates.UNRENDERED),!0}else if(d.length>=(adf.mf.api.amx.fragmentRecursionLimit||
25)&&0<=d.indexOf(c))return a.setState(adf.mf.api.amx.AmxNodeStates.UNRENDERED),adf.mf.internal.amx.errorHandlerImpl(null,Error(adf.mf.resource.getInfoString("AMXErrorBundle","ERROR_FRAGMENT_RECURSIVE_LOOP"))),adf.mf.log.logInfoResource("AMXInfoBundle",adf.mf.log.level.SEVERE,"fragmentHandler.prototype._createChildrenFromFragment","amx_fragment_RECURSION",a.getId(),c),!0;return!1};a.prototype._createChildrenFromFragment=function(a){var c=this._getFragmentUri(a),d=a.getAttribute("_fragmentState");
if(null==c)a.setState(adf.mf.api.amx.AmxNodeStates.UNRENDERED),d.waitingOnEl=!1,d.childrenCreated=!0;else{if(this._isInfiniteLoop(a,c))return d.waitingOnEl=!1,d.childrenCreated=!0;var e=adf.mf.log.AMX.isLoggable(adf.mf.log.level.FINEST);e&&adf.mf.log.AMX.logp(adf.mf.log.level.FINEST,"amx:fragment","_createChildrenFromFragment","Requesting the fragment tag for AMX node '"+a.getId()+"' and URI: "+c);var g=adf.mf.internal.amx.__getAmxTagForPage(c,!0);if(null!=g)return e&&adf.mf.log.AMX.logp(adf.mf.log.level.FINEST,
"amx:fragment","_createChildrenFromFragment","Fragment was cached. Calling _handleLoadedFragment (URI: "+c+", AmxNode: "+a.getId()+")"),d.fragmentLoading=!1,c=d.updateArguments,null!=c&&(c.cancel(),delete d.updateArguments),this._handleLoadedFragment(a,g),!0;e&&adf.mf.log.AMX.logp(adf.mf.log.level.FINEST,"amx:fragment","_createChildrenFromFragment","Waiting on the fragment file to load and the tags to be built (URI: "+c+", AmxNode: "+a.getId()+")");d.fragmentLoading||(d.fragmentLoading=!0,this._loadFragment(a,
c));return!1}};a.prototype._handleLoadedFragment=function(a,c){var d=adf.mf.log.AMX.isLoggable(adf.mf.log.level.FINEST);a.getState()==adf.mf.api.amx.AmxNodeStates.WAITING_ON_EL_EVALUATION?(d&&adf.mf.log.AMX.logp(adf.mf.log.level.FINEST,"amx:fragment","_handleLoadedFragment","Node is waiting on EL: "+a.getId()),a.setState(adf.mf.api.amx.AmxNodeStates.ABLE_TO_RENDER)):(d&&adf.mf.log.AMX.logp(adf.mf.log.level.FINEST,"amx:fragment","_handleLoadedFragment","Fragment tag promise callback invoked for node: "+
a.getId()),d=c.buildAmxNode(a,null),a.addChild(d),adf.mf.log.AMX.isLoggable(adf.mf.log.level.FINEST)&&adf.mf.log.AMX.logp(adf.mf.log.level.FINEST,"amx:fragment","_fragmentLoaded","Children created. Node: "+a.getId()),a.getAttribute("_fragmentState").childrenCreated=!0)};a.prototype._loadFragment=function(a,c){var d=adf.mf.log.AMX.isLoggable(adf.mf.log.level.FINEST);adf.mf.api.amx.showLoadingIndicator();adf.mf.internal.amx.__getAmxTagForPage(c,!1).then(function(){try{var c=a.getAttribute("_fragmentState");
if(c.fragmentLoading){d&&adf.mf.log.AMX.logp(adf.mf.log.level.FINEST,"amx:fragment","_loadFragment","The fragment tag promise was fulfilled. Calling markNodeForUpdate for node: "+a.getId());c.fragmentLoading=!1;var g=new adf.mf.internal.amx.AmxNodeUpdateArguments;g.setAffectedAttribute(a,"_fragmentLoaded");c.updateArguments=g;adf.mf.api.amx.markNodeForUpdate(g)}else d&&adf.mf.log.AMX.logp(adf.mf.log.level.FINEST,"amx:fragment","_loadFragment","The fragment tag promise has completed, but the state is no longer loading. The markNodeForUpdate method will not be invoked for node: "+
a.getId())}finally{adf.mf.api.amx.hideLoadingIndicator()}},function(c,d){adf.mf.log.logInfoResource("AMXInfoBundle",adf.mf.log.level.SEVERE,"amx-fragment._loadFragment","MSG_ERROR_IN_SCRIPT","amx-fragment._loadFragment","Error loading fragment '"+a.getAttribute("src")+"': "+c);d instanceof Error&&adf.mf.internal.amx.errorHandlerImpl(null,d);var h=a.getAttribute("_fragmentState");h.waitingOnEl=!1;h.childrenCreated=!0;a.setState(adf.mf.api.amx.AmxNodeStates.UNRENDERED);adf.mf.api.amx.hideLoadingIndicator()});
a.setState(adf.mf.api.amx.AmxNodeStates.ABLE_TO_RENDER)};a.prototype._createFacets=function(a,c){var d=adf.mf.log.AMX.isLoggable(adf.mf.log.level.FINEST);d&&adf.mf.log.AMX.logp(adf.mf.log.level.FINEST,"amx:fragment","_createFacets","Creating the facets for "+a.getId());var e=a.getAttribute("_facetsToBeCreated");a.setAttributeResolvedValue("_facetsToBeCreated",null);var g=a.getAttribute("_facetVisitData");null==g&&(g=[],a.setAttributeResolvedValue("_facetVisitData",g));var h=c?new adf.mf.internal.amx.AmxNodeUpdateArguments:
null;d&&adf.mf.log.AMX.logp(adf.mf.log.level.FINEST,"amx:fragment","_createFacets","Number of facets to be created: "+e.length);for(var k=0,m=e.length;k<m;++k){var n=e[k],t=n.getAttribute("facetName"),u=n.getId();g.push({key:u,name:t,attributes:n.getAttribute("_attributeData")});for(var t=a.createStampedChildren(u,[t]),u=0,v=t.length;u<v;++u)t[u].__setRenderingParent(n);c&&0<t.length&&h.setAffectedAttribute(n,"_facetCreated");n.setState(adf.mf.api.amx.AmxNodeStates.ABLE_TO_RENDER)}c&&0<h.getAffectedNodes().length&&
(d&&adf.mf.log.AMX.logp(adf.mf.log.level.FINEST,"amx:fragment","_createFacets","The fragment was already rendered, calling markNodeForUpdate to update the UI with the facets"),adf.mf.api.amx.markNodeForUpdate(h))}})();